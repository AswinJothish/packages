---
import CheckoutAddress from "../components/CheckoutAddress";
import NavBar from "../components/NavBar";
import ToastProvider from "../components/ToastProvider";
import { IoIosArrowUp } from "react-icons/io";
// Initial empty state for SSR
const cartItems = [];
---

<NavBar client:idle />
<ToastProvider client:visible />
<div id="checkout-container" class="pt-10 px-5 max-w-7xl mx-auto">
  <h1 class="font-bold text-xl font-serif py-10">Checkout</h1>
  
  <div class="flex flex-row md:flex-row gap-6">
    <div class="w-2/3">
        <div class="px-5 bg-white">
          <!-- Delivery Address List Container -->
        
           <CheckoutAddress />
         
        </div>
      </div>
    
    <!-- Left Column - Cart Items -->
    <div class="md:w-1/3">
      <div class="flex-grow ">
        <div id="cart-items-container" class="border rounded-xl p-5 bg-white">
          <!-- Items will be rendered here -->
        </div>
      </div>
      
      <!-- Right Column - Summary -->
      <div class="">
        <div id="cart-summary" class="border rounded-xl p-5 bg-white sticky top-24">
          <!-- Summary will be rendered here -->
        </div>
      </div>
    </div>
    
  </div>
  <!-- Edit Address Dialog -->

  
  
</div>

<script>
    import { ImgbaseUrl, baseUrl } from "../lib/config";
    import location from "../../public/images/location.png";
    import edit from "../../public/images/edit.png";
 
    const cartUpdateEvent = new Event('cartUpdate');
    window.checkoutState = {
      cartItems: JSON.parse(localStorage.getItem('checkoutItems') || '[]'),
      userData: null
    };
  
    // async function fetchUserData() {
    //   const userId = localStorage.getItem('_id');
    //   if (!userId) return;
  
    //   try {
    //     const response = await fetch(`${baseUrl}/users/get?id=${userId}`);
    //     if (!response.ok) throw new Error('Failed to fetch user data');
        
    //     window.checkoutState.userData = await response.json();
    //     document.dispatchEvent(new Event('userDataUpdate'));
    //   } catch (error) {
    //     console.error('Error fetching user data:', error);
    //   }
    // }
  
//     function renderDeliveryAddresses() {
//       const container = document.getElementById('delivery-address-container');
//       const userData = window.checkoutState.userData;
  
//       if (!container || !userData) return;
  
//       const addressHTML = userData.data.deliveryAddress.map(address => `
//     <CheckoutAddress address="${address}" />
//   `).join('');

  
//       container.innerHTML = addressHTML;
//     }
  
    function renderCartItems() {
      const container = document.getElementById('cart-items-container');
      if (!container) return;
  
      const itemsHTML = window.checkoutState.cartItems.map(item => `
        <div class="cart-item flex items-center gap-4 border-b last:border-b-0 py-4" key="${item._id}">
          <div class="w-24 h-24 border rounded-lg overflow-hidden flex-shrink-0">
            <img 
              src="${ImgbaseUrl}${item.productId.productImages[0]}"
              alt="${item.productId.productName}"
              class="w-full h-full object-contain"
            />
          </div>
          <div class="flex flex-col flex-grow min-w-0">
            <h3 class="font-bold text-lg font-merr capitalize truncate">${item.productId.productName}</h3>
            <p class="text-gray-600 text-sm">Brand: ${item.productId.brand}</p>
            <p class="mt-1 text-sm">
              <span class="text-gray-800">Quantity: ${item.quantity}</span>
            </p>
            <div class="flex items-center gap-2 mt-1">
              <span class="text-sm text-green-700">Inclusive GST</span> <span class="text-gray-500 text-sm line-through">₹${item.productId.strikePrice}</span>
              <span class="text-base font-semibold">₹${item.productId.customerPrice}</span>
            </div>
          </div>
        </div>
      `).join('');
  
      container.innerHTML = itemsHTML;
    }
  
    function renderCartSummary() {
      const container = document.getElementById('cart-summary');
      if (!container) return;
  
      const subtotal = window.checkoutState.cartItems.reduce(
        (sum, item) => sum + (item.productId.customerPrice * item.quantity),
        0
      );
  
      const total = subtotal;
  
      container.innerHTML = `
        <div class="space-y-4">
          <h2 class="text-xl font-bold font-serif">Payment Summary</h2>
          
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600">Subtotal</span>
              <span class="font-medium">₹ ${subtotal}</span>
            </div>
            
            <div class="flex justify-between">
              <span class="text-gray-600">Delivery Charges</span>
              <span class="font-medium"><span class='text-green-600'>Free Delivery</span> <span class='line-through'>₹ 50</span> </span>
            </div>
            
            <div class="border-t pt-3">
              <div class="flex justify-between">
                <span class="font-semibold">Total</span>
                <span class="font-bold">₹${total}</span>
              </div>
            </div>
          </div>
  
          <button class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors mt-6">
            Proceed to Payment
          </button>
        </div>
      `;
    }
  
    document.addEventListener('cartUpdate', () => {
      renderCartItems();
      renderCartSummary();
    });
  
  //  document.addEventListener('userDataUpdate', renderDeliveryAddresses);
  
    async function initialize() {
      //await fetchUserData();
      renderCartItems();
      renderCartSummary();
    }
    initialize();
  
    // document.getElementById('toggle-addresses').addEventListener('click', () => {
    //   const container = document.getElementById('delivery-address-container');
    //   container.classList.toggle('hidden');
    //   document.getElementById('toggle-addresses').classList.toggle('rotate-90');
    // });
    
   
  </script>
  
<style>
    .rotate-90 {
  transform: rotate(180deg);
  transition: transform 0.3s ease; /* Smooth transition */
}
</style>