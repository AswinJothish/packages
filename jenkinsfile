stage('Deploy to EC2') {
    steps {
        script {
            // Use withCredentials instead of sshagent
            withCredentials([sshUserPrivateKey(
                credentialsId: 'ec2-ssh-key',
                keyFileVariable: 'SSH_KEY',
                usernameVariable: 'SSH_USER'
            )]) {
                sh """
                    # Set proper permissions for the key
                    chmod 600 ${SSH_KEY}
                    
                    # Stop existing services
                    ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${SSH_USER}@${EC2_HOST} '
                        cd /home/ubuntu/sunstar-demo
                        pm2 stop all || true
                    '
                    
                    # Copy built files
                    scp -i ${SSH_KEY} -o StrictHostKeyChecking=no -r ${WORKSPACE}/client/dist ${SSH_USER}@${EC2_HOST}:/home/ubuntu/sunstar-demo/client/
                    scp -i ${SSH_KEY} -o StrictHostKeyChecking=no -r ${WORKSPACE}/admin/dist ${SSH_USER}@${EC2_HOST}:/home/ubuntu/sunstar-demo/admin/
                    scp -i ${SSH_KEY} -o StrictHostKeyChecking=no -r ${WORKSPACE}/server ${SSH_USER}@${EC2_HOST}:/home/ubuntu/sunstar-demo/
                    
                    # Start services
                    ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${SSH_USER}@${EC2_HOST} '
                        cd /home/ubuntu/sunstar-demo/server
                        npm install
                        pm2 start ecosystem.config.js
                        pm2 save
                    '
                """
            }
        }
    }
}